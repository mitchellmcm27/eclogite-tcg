Cite this code using the following DOI: [10.5281/zenodo.10835976](https://doi.org/10.5281/zenodo.10835976).

## Get started using Docker

The following command downloads a prebuilt Docker image, starts an interactive container, and binds the local directory to a shared folder inside the container:

```bash
docker run -it --rm -v $PWD:/home/tcg/shared/eclogite-tcg registry.gitlab.com/mitchellmcm27/eclogite-tcg
```

The main benefit of using this Docker image is that it includes prebuilt binaries for the thermodynamic database (endmembers and phases) and reaction objects.
Building these from scratch takes several hours.

The Docker container also automatically includes several useful dependencies such as
- an installation of ThermoCodegen (TCG), which is required for running the models,
- the present repository at **/home/tfuser/shared/eclogite-tcg/**,
- *TCG_SLB*, which provides convenient Python classes and scripts for working with the Stixrude & Lithgow-Bertelloni (2011, 2021) databases,
- Python (including numpy, matplotlib, and scipy),
- Julia, and
- the equilibrium thermodynamics software Perple_X.

Within the Docker container, change to the following directory
```bash
cd shared/eclogite-tcg
```

## Thermodynamic database and reactions

A custom thermodynamic database using the data from Stixrude and Lithgow-Bertelloni (2021) is included as **tcg_slb/database/tcg_stx21_database.tar.gz**.
Although the scripts, source code, and data for generating this database are provided, doing so is not necessary as long as the **.tar.gz** file is in place.

Descriptions of the eclogitization reactions are included as **\*.rxml** files.
Because generating the C++ code for these reactions can take several hours, the provided Docker image includes pre-built binaries.
Additional reactions can be added, but then the reactions will need to be re-built.

If reactions are edited and need to be re-built, you can do so as follows:

```bash
cd tcg_slb
scripts/generate_reactions_eclogite -v 21
scripts/build_reactions database/reactions/[name].rxml
```

Note that the ``build_reactions`` command can take several hours, depending mainly on the number of phases and endmembers. It is thus recommended, but not necessary, to pass the name of the exact reaction that needs to be built, as shown above.

The `scripts/generate_reactions` and `scripts/generate_reactions_eclogite` files provide examples of how to generate a set of reaction descriptions (**.rxml** files) between endmembers of a specific thermodynamic database.

## Model calculations

Model calculations are provided as Python scripts in the **models** directory.

```bash
cd models
```

The following 4 files are included:

- `parallel_experiment2.py` runs the geodynamic model of crustal thickening at the Moho.
- `parallel_pd.py` generates a (_T_,_P_) pseudosection for comparing density with Perple_X results.
- `parallel_profile.py` generates a 1-d profile through (_T_,_P_)-space for comparing phase mode with Perple_X results.
- `damkohler-fit.ipynb` shows how Damkohler number is fit to empirical data.

By default the **parallel_\*** scripts use all available CPU cores.

Arguments can be passed as follows to customize the model runs:

| CLI argument    |  Purpose                           | Default                      |
|-----------------|------------------------------------|------------------------------|
|   `-n [int]`    | Number of CPU processes to use     | `mp.cpu_count()`             |
|   `-e [float]`  | Dimensionless ending time          | 1                            |
|   `-c [string]` | Bulk composition to use, by name   | an array of 4 compositions   |
|   `-r [string]` | Reaction to use, by name           | eclogitization_2024_stx21_rx |
|   `-q`          | "Quick" run (_Da_ â‰¤ 1e4 only)      | False                        |
|   `-f`          | Force model to re-run              | False                        |
|   `-p [string]` | String to prefix output directory  | None                         |

In most cases, you can use the `-c` argument to specifiy any Bulk composition, provided that Perple_X output data exist for it in the **perple_x/output** folder. 
The only requirement to generate such data is an oxide bulk composition in mol% or wt% (see Perple_x section below).

## Model output

All outputs are saved to the **models/output** directory.
Outputs will be automatically grouped into subdirectories based on the name of the reaction and composition.

## Model initialization using Perple_X

The model depends on equilibrium thermodynamics for initial composition.
Perple_X solves for equilibrium thermodynamic properties using a Gibbs free energy minimization routine.
The model scripts described above then read the text files generated by Perple_X to initialize the reactive thermodynamic models.
Equilibrium data are already included for the bulk compositions defined in the accompanying manuscripts, so that the models can be run with no additional steps.

### Adding new compositions

Additional compositions are available in the **perple_x/compositions.json** file.
This file can be edited to add any number of additional bulk compositions.
The **compositions.json** file is ultimately read by Perple_X to solve for equilibrium thermodynamics.

A Julia interface for programatically interacting with Perple_X (based on [StatGeochem](https://osf.io/tjhmw/)) is included as **perplex_api.jl**
The script **solve_composition.jl** reads **compositions.json** file and passes the data to Perple_X.

If a composition needs to be added that does not already exist, use the following steps:

- Add the oxide percentages to **models/perple_x/compositions.json** file, making sure to use the same format as the existing compositions.
- Within the **perple_x** directory, run `julia solve_composition.jl [name]` where `[name]` is the unique identifier, the key for the composition object in **compositions.json** (e.g., `sammon_2021_lower_crust`).
- The composition can now be used in python scripts by passing the `-c [name]` argument as described above.
- Pseudosection calculations in Perple_X (i.e., the **vertex** program) can take significant time, and thus only are only run if necessary. If a composition changes and **vertex** needs to be run again, pass the `-f` argument to `solve_composition` to force Perple_X to re-calculate everything from scratch.

## Additional plotting in R

Some plots are more convenient to make in R after the models have been run.
For this purpose, the model saves a summary of key outputs to a **_summary.csv** file.

An R script for reading and working with this file is provided in the **./r** directory.
