FROM registry.gitlab.com/cianwilson/thermocodegen:focal

# Install dependencies
RUN pip install --upgrade\
        jill==0.11.5\
        numpy==1.24.4\
        scipy==1.10.1\
        pandas==2.0.3\
        numexpr==2.7.3\
        matplotlib==3.7.5\
        sympy==1.12\
    && jill install 1.9 --upstream Official --confirm\
    && julia -e 'using Pkg; Pkg.add(["JSON"]);'\
    # Clone the eclogitization repo
    && git clone https://gitlab.com/mitchellmcm27/eclogite-tcg.git /home/tcg/shared/eclogite-tcg\
    && cd /home/tcg/shared/eclogite-tcg\
    # Set permissions
    && chgrp adm -R .\
    && chmod g+w+x -R .\
    # Generate and build reactions
    && cd tcg_slb\
    && scripts/generate_reactions_eclogite -v 21\
    && scripts/build_reactions database/reactions/eclogitization_2024_stx21_rx.rxml\
    # Install Perple_x v7.0.10
    && mkdir ~/resources\
    && git clone -n https://github.com/jadconnolly/Perple_X.git ~/resources/perplex-stable\
    && cd ~/resources/perplex-stable\
    && git checkout 1aeec2f4f5d31762ecc8a5abbcb6338046406306\
    && cd src\
    && make -j${nproc}\
    # copy files to the directory required by the Perple_X Julia interface
    && cd ~/resources/perplex-stable\
    && cp src/* .\
    && cp -r datafiles/* .\
    && cp optionfiles/* .

# R Stuff
RUN apt-get update\
    && apt-get install -y r-base\
    && R -e "install.packages(c('tidyverse', 'ggthemes', 'colorspace', 'latex2exp','scales','directlabels','showtext'))"

WORKDIR /home/tcg/shared/eclogite-tcg